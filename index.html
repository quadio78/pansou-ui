<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#000000"/>
    <title>Tusita - 让街友更好搜电影的网盘搜索工具</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="msvalidate.01" content="9C398069E06C029D29F994105CDF858B" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cmp.gatekeeperconsent.com/min.js" data-cfasync="false"></script>
    <script src="https://the.gatekeeperconsent.com/cmp.min.js" data-cfasync="false"></script> 
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ios-bg': '#f5f7ff',
                        'ios-card': '#ffffff',
                        'ios-blue': '#0a84ff',
                        'ios-gray': '#8e8e93',
                        'ios-dark': '#1c1c1e'
                    },
                    boxShadow: {
                        'ios': '0 4px 20px rgba(0,0,0,0.08)',
                        'ios-card': '0 2px 10px rgba(0,0,0,0.05)'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.loli.net/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7ff 0%, #f0f4ff 100%);
            min-height: 100vh;
            color: #1c1c1e;
            transition: all 0.3s ease;
        }
        
        .ios-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.5);
            overflow: hidden;
        }
        
        .search-box {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .search-box.focused {
            box-shadow: 0 10px 30px rgba(10, 132, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .platform-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }
        
        .result-item {
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        
        .result-item:hover {
            background-color: rgba(10, 132, 255, 0.03);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-dots {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background-color: #0a84ff;
            border-radius: 50%;
            margin: 0 3px;
            animation: bounce 1.5s infinite ease-in-out;
        }
        
        .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        
        .platform-tag {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 20px;
            background: rgba(10, 132, 255, 0.1);
            color: #0a84ff;
        }
        
        .password-tag {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
            font-weight: 500;
            display: inline-block;
            line-height: 1.4;
            flex-shrink: 0; /* 防止在flex布局中被压缩 */
        }
        
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 8px;
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        #backToTopBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: rgba(10, 132, 255, 0.8);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }

        #backToTopBtn:hover {
            background-color: rgba(10, 132, 255, 1);
            transform: scale(1.1);
        }

        #mobileAccessBtn {
            position: fixed;
            bottom: 80px; /* Positioned above the back-to-top button */
            right: 20px;
            background-color: rgba(44, 187, 99, 0.8); /* Green color */
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }

        #mobileAccessBtn:hover {
            background-color: rgba(44, 187, 99, 1);
            transform: scale(1.1);
        }

        #installPwaBtn {
            position: fixed;
            bottom: 80px; /* Adjusted to be on top of backToTopBtn on mobile */
            right: 20px;
            background-color: rgba(88, 86, 214, 0.8); /* Purple color */
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            font-size: 22px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: opacity 0.3s, transform 0.3s;
            z-index: 1000;
        }

        #installPwaBtn:hover {
            background-color: rgba(88, 86, 214, 1);
            transform: scale(1.1);
        }

        /* QR Code Modal Styles */
        .qr-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }
        .qr-modal-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            text-align: center;
            position: relative;
            transform: scale(0.9);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .qr-modal-overlay.visible .qr-modal-content {
            transform: scale(1);
            opacity: 1;
        }
        .qr-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: #8e8e93;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .qr-modal-close:hover {
            transform: scale(1.2);
        }
        #qrcode {
            margin: 1.5rem auto 0;
            width: 200px !important;
            height: 200px !important;
        }

        .filter-btn {
            padding: 8px 16px;
            border-radius: 20px;
            background-color: rgba(0,0,0,0.05);
            color: #1c1c1e;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            min-height: 44px; /* 增加触摸区域 */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .filter-btn:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .filter-btn.active {
            background-color: #0a84ff;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(10, 132, 255, 0.2);
        }
        
        .category-tab {
            padding: 8px 16px;
            border-radius: 20px;
            background-color: rgba(0,0,0,0.05);
            color: #1c1c1e;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            min-height: 44px; /* 增加触摸区域 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }

        .category-tab:hover {
            background-color: rgba(0,0,0,0.1);
        }

        .category-tab.active {
            background-color: #0a84ff;
            color: white;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(10, 132, 255, 0.2);
        }
        
        /* Tab内容区域样式 */
        #categoryContentContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 0.75rem;
            padding: 1rem;
        }

        #categoryContentContainer .category-item-btn,
        #categoryContentContainer .hot-search-btn {
            transition: all 0.2s ease;
            font-weight: 500;
            text-align: center;
            justify-content: center;
            width: 100%; /* 确保按钮填满网格单元 */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block; /* 确保 ellipsis 生效 */
        }
        
        #categoryContentContainer .category-item-btn:hover,
        #categoryContentContainer .hot-search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        /* 移动端触摸优化 */
        @media (max-width: 768px) {
            body {
                padding-top: 1.5rem; /* 32px -> 24px */
                padding-bottom: 1.5rem;
            }

            .text-center.mb-10 {
                margin-bottom: 2rem; /* 40px -> 32px */
            }

            #searchContainer {
                margin-bottom: 1.5rem; /* 32px -> 24px */
            }

            #categoryTabsContainer {
                margin-bottom: 1.5rem; /* 24px */
            }

            #categoryContentContainer {
                gap: 0.75rem; /* 8px -> 12px */
                padding: 0.75rem; /* 16px -> 12px */
            }

            .hot-search-btn, .category-item-btn {
                min-height: 40px;
                padding: 6px 14px;
                font-size: 0.9rem;
            }

            #resultsContainer .ios-card {
                border-radius: 16px;
            }

            .result-item {
                padding: 12px !important;
            }

            .result-item .text-lg {
                font-size: 1rem; /* 18px -> 16px */
                line-height: 1.4;
            }

            .result-item .text-xs {
                font-size: 0.7rem; /* 12px -> 11.2px */
            }
            
            .password-tag {
                padding: 4px 10px;
                font-weight: 600;
                border-radius: 12px;
                box-shadow: 0 2px 6px rgba(52, 199, 89, 0.2);
            }

            #searchButton, #resetButton {
                min-height: 44px;
                padding: 10px 20px !important; /* 使用 !important 确保覆盖行内样式 */
                flex-shrink: 0; /* 防止按钮被压缩 */
            }
            
            #backToTopBtn {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
            }
        }

        /* 新版搜索模式切换控件样式 */
        .search-mode-btn.active {
            color: #0a84ff;
        }
        .search-mode-btn {
            color: #8e8e93;
        }
        .scroll-container {
            display: flex;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        .scroll-container::-webkit-scrollbar {
            display: none; /* Safari and Chrome */
        }
        .scroll-item {
            flex: 0 0 auto;
            width: 80%; /* 在移动端显示大部分卡片，但不是全部 */
            margin-right: 1rem;
        }
        @media (min-width: 768px) {
            .scroll-item {
                width: calc(33.333% - 1rem); /* 在桌面端显示三列 */
            }
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9067024774549867"
     crossorigin="anonymous"></script>
     <meta name="google-adsense-account" content="ca-pub-9067024774549867">
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DQW3NHY60Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DQW3NHY60Z');
</script>
<body class="min-h-screen py-8 px-4 sm:px-8">
    <div class="max-w-4xl mx-auto">
        <!-- 标题区域 -->
        <div class="text-center mb-10 fade-in">
            <div class="w-16 h-16 flex items-center justify-center mx-auto mb-4">
            </div>
            <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-ios-blue to-blue-500 bg-clip-text text-transparent">Tusita</h1>
            <p class="text-ios-gray text-lg">让街友更好搜电影的网盘搜索工具</p>
            
            <!-- 资源集合入口 -->
            <div class="mt-6 text-center">
                <a href="https://txjuqabunzfi.us-east-1.clawcloudrun.com/" class="inline-flex items-center bg-gradient-to-r from-ios-blue to-blue-500 text-white rounded-xl py-3 px-6 font-medium hover:opacity-90 transition-opacity shadow-lg">
                    <i class="fas fa-folder-open mr-2"></i>
                    在线看
                    <i class="fas fa-chevron-right ml-2 text-sm"></i>
                </a>
            </div>
        </div>
        </a>

        <!-- 公告 -->
        <div class="ios-card p-4 mb-8 bg-green-50">
             <p class="text-center text-green-600 font-bold">✅ 测试版 没公告</p>
        </div>

        <!-- 搜索框 -->
        <div class="ios-card p-1 mb-8 search-box" id="searchContainer">
            <div class="flex items-center">
                <div class="pl-4 text-ios-gray">
                    <i class="fas fa-search"></i>
                </div>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="搜索网盘资源，支持115、百度云、阿里云盘等"
                    class="w-full py-4 px-4 bg-transparent outline-none text-lg placeholder-ios-gray"
                    autocomplete="off"
                    inputmode="search"
                    enterkeyhint="search"
                >
                <button
                    id="resetButton"
                    class="bg-gradient-to-r from-gray-400 to-gray-500 text-white rounded-xl py-3 px-6 m-1 font-medium hover:opacity-90 transition-opacity hidden"
                    title="重置搜索"
                >
                    重置
                </button>
                <button
                    id="searchButton"
                    class="bg-gradient-to-r from-ios-blue to-blue-500 text-white rounded-xl py-3 px-6 m-1 font-medium hover:opacity-90 transition-opacity"
                >
                    搜索
                </button>
            </div>
        </div>

        <!-- ADS -->
        <!-- <script async="async" data-cfasync="false" src="//unhealthyirreparable.com/03202fae5f6b70e21d670c2cffec94c2/invoke.js"></script>
        <div id="container-03202fae5f6b70e21d670c2cffec94c2"></div> -->

        <!-- 搜索模式切换 -->
        <!-- 搜索模式切换 -->
        <div class="flex justify-center mb-6">
            <div id="searchModeContainer" class="relative grid grid-cols-2 items-center bg-gray-200/60 p-1 rounded-full w-64">
                <div id="searchModeSlider" class="absolute top-1 bottom-1 left-1 w-[calc(50%-4px)] bg-white rounded-full shadow-md transition-transform duration-300 ease-in-out" style="transform: translateX(calc(100% + 4px));"></div>
                <button id="modeFast" class="search-mode-btn z-10 py-2 text-center text-sm font-semibold transition-colors duration-300">快速搜索</button>
                <button id="modeDeep" class="search-mode-btn active z-10 py-2 text-center text-sm font-semibold transition-colors duration-300">深度搜索</button>
            </div>
        </div>

        <!-- 随机资源合集展示 -->
        <div id="randomCollections" class="mt-8 mb-8"></div>
        
        <!-- 分类Tab切换 -->
        <div id="categoryTabsContainer" class="mb-6 px-2 ios-card">
            <!-- Tab导航 -->
            <div class="flex flex-wrap gap-2 p-4 border-b border-gray-100">
                <button class="category-tab active" data-category="hot">热搜</button>
                <button class="category-tab" data-category="电影">电影</button>
                <button class="category-tab" data-category="电视剧">电视剧</button>
                <button class="category-tab" data-category="小说">小说</button>
                <button class="category-tab" data-category="综艺">综艺</button>
                <button class="category-tab" data-category="游戏">游戏</button>
                <button class="category-tab" data-category="动漫">动漫</button>
            </div>
            
            <!-- Tab内容 -->
            <div id="categoryContentContainer" class="flex flex-wrap gap-2 items-center p-4">
                <!-- 内容将在这里动态生成 -->
            </div>
        </div>

        <!-- 筛选器 -->
        <div id="filterContainer" class="mb-6 px-2 hidden">
            <div class="flex flex-wrap gap-2">
                <!-- 筛选按钮将在这里动态生成 -->
            </div>
        </div>

        <!-- 结果统计 -->
        <div id="resultsHeader" class="mb-6 px-2 hidden">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <h2 class="text-xl font-semibold">搜索结果</h2>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-ios-gray">排序:</span>
                        <select id="sortSelect" class="text-sm bg-white border border-gray-200 rounded-lg px-3 py-1 text-ios-dark focus:outline-none focus:ring-2 focus:ring-ios-blue focus:border-transparent">
                            <option value="default">默认</option>
                            <option value="date-desc">时间 (新到旧)</option>
                            <option value="date-asc">时间 (旧到新)</option>
                            <option value="name-asc">名称 (A-Z)</option>
                            <option value="name-desc">名称 (Z-A)</option>
                        </select>
                    </div>
                    <span id="resultsCount" class="text-ios-gray"></span>
                </div>
            </div>
        </div>
        
        <!-- 结果容器 -->
        <div id="resultsContainer" class="space-y-5"></div>
        
        <div class="mt-8 text-center text-ios-gray">
            <p class="text-sm">
            </p>
            <button id="clearHotSearches" class="mt-2 text-xs text-red-500 hover:underline">清除热搜记录</button>
            <button id="deleteSingleHotSearch" class="mt-2 ml-2 text-xs text-orange-500 hover:underline">删除指定热搜</button>
        </div>
    </div>

    <button id="backToTopBtn" title="返回顶部">
        <i class="fas fa-arrow-up"></i>
    </button>

    <button id="mobileAccessBtn" title="手机访问">
        <i class="fas fa-qrcode"></i>
    </button>

    <button id="installPwaBtn" title="安装应用">
        <i class="fas fa-download"></i>
    </button>

    <script>
        // 平台图标和名称映射
        const platformMap = {
            '115': { name: '115网盘', icon: 'fa-box', color: 'bg-orange-500' },
            '123': { name: '123网盘', icon: 'fa-hashtag', color: 'bg-green-500' },
            'mobile': { name: '移动云盘', icon: 'fa-mobile-alt', color: 'bg-blue-500' },
            'xunlei': { name: '迅雷云盘', icon: 'fa-bolt', color: 'bg-yellow-500' },
            'aliyun': { name: '阿里云盘', icon: 'fa-cloud', color: 'bg-purple-500' },
            'uc': { name: 'UC网盘', icon: 'fa-compass', color: 'bg-red-500' },
            'tianyi': { name: '天翼云盘', icon: 'fa-cloud', color: 'bg-pink-500' },
            'quark': { name: '夸克网盘', icon: 'fa-search', color: 'bg-indigo-500' },
            'others': { name: '其他网盘', icon: 'fa-ellipsis-h', color: 'bg-gray-500' },
            'baidu': { name: '百度网盘', icon: 'fa-database', color: 'bg-blue-600' }
        };
        
        // DOM元素
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');
        const resetButton = document.getElementById('resetButton');
        const searchContainer = document.getElementById('searchContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsHeader = document.getElementById('resultsHeader');
        const resultsCount = document.getElementById('resultsCount');
        const filterContainer = document.getElementById('filterContainer');
        const sortSelect = document.getElementById('sortSelect');
        const randomCollectionsEl = document.getElementById('randomCollections');
        
        // 新版搜索模式控件元素
        const modeFastBtn = document.getElementById('modeFast');
        const modeDeepBtn = document.getElementById('modeDeep');
        const modeSlider = document.getElementById('searchModeSlider');
        
        let currentSearchMode = 'deep'; // 'fast' or 'deep'

        let currentData = null; // 缓存当前搜索结果
        let currentFilter = 'all'; // 当前筛选条件
        let isInitialLoad = true; // 跟踪是否为初始加载状态
        let searchTimeout = null; // 搜索防抖定时器
        let isSearching = false; // 搜索状态标记
        
        // 添加事件监听器
        searchInput.addEventListener('focus', () => {
            searchContainer.classList.add('focused');
        });
        
        searchInput.addEventListener('blur', () => {
            searchContainer.classList.remove('focused');
        });
        
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                clearTimeout(searchTimeout);
                performSearch();
            }
        });
        
        
        searchButton.addEventListener('click', performSearch);
        
        // 重置按钮事件
        const resetSearch = () => {
            searchInput.value = '';
            resultsContainer.innerHTML = '';
            resultsHeader.classList.add('hidden');
            filterContainer.classList.add('hidden');
            resetButton.classList.add('hidden');
            
            const categoryTabsContainer = document.getElementById('categoryTabsContainer');
            if (categoryTabsContainer) {
                categoryTabsContainer.classList.remove('hidden');
            }
            if (randomCollectionsEl) {
                randomCollectionsEl.style.display = 'block';
            }

            currentData = null;
            currentFilter = 'all';
            isInitialLoad = true;
            searchInput.focus();
        };
        
        resetButton.addEventListener('click', resetSearch);
        
        // 监听输入框变化，控制重置按钮显示/隐藏
        searchInput.addEventListener('input', () => {
            if (searchInput.value.trim() !== '') {
                resetButton.classList.remove('hidden');
            } else {
                resetButton.classList.add('hidden');
            }
        });
        
        // 排序选择事件
        sortSelect.addEventListener('change', () => {
            if (currentData) {
                renderResults(currentData, currentFilter);
            }
        });
        
        // 示例搜索点击事件
        document.querySelectorAll('.examples').forEach(el => {
            el.addEventListener('click', (e) => {
                searchInput.value = e.target.textContent;
                performSearch();
            });
        });

        // 清除热搜记录
        const clearButton = document.getElementById('clearHotSearches');
        clearButton.addEventListener('click', async () => {
            const password = prompt('请输入清除密码:');
            if (password === null) { // 用户点击了取消
                return;
            }

            try {
                const response = await fetch('/api/clear-hot-searches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });

                if (response.ok) {
                    alert('热搜记录已清除！');
                    // 检查当前是否是热搜tab，如果是则刷新内容
                    const activeTab = document.querySelector('.category-tab.active');
                    if (activeTab && activeTab.getAttribute('data-category') === 'hot') {
                        fetchAndRenderHotTabContent();
                    }
                } else {
                    const result = await response.json();
                    alert(`清除失败: ${result.error || '未知错误'}`);
                }
            } catch (error) {
                alert(`请求失败: ${error.message}`);
            }
        });

        // 删除指定热搜
        document.getElementById('deleteSingleHotSearch').addEventListener('click', async () => {
            const termToDelete = prompt('请输入要删除的热搜词:');
            if (!termToDelete || termToDelete.trim() === '') {
                return;
            }

            const password = prompt('请输入密码:');
            if (password === null) {
                return;
            }

            try {
                const response = await fetch('/api/delete-hot-search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password, term: termToDelete.trim() })
                });

                if (response.ok) {
                    alert(`热搜词 "${termToDelete}" 已删除！`);
                    // 检查当前是否是热搜tab，如果是则刷新内容
                    const activeTab = document.querySelector('.category-tab.active');
                    if (activeTab && activeTab.getAttribute('data-category') === 'hot') {
                        fetchAndRenderHotTabContent();
                    }
                } else {
                    const result = await response.json();
                    alert(`删除失败: ${result.error || '未知错误'}`);
                }
            } catch (error) {
                alert(`请求失败: ${error.message}`);
            }
        });


        // 获取并渲染热搜tab内容
        async function fetchAndRenderHotTabContent() {
            try {
                const response = await fetch('/api/hot-searches');
                if (!response.ok) return;

                const { hotSearches } = await response.json();
                const container = document.getElementById('categoryContentContainer');
                
                if (hotSearches && hotSearches.length > 0) {
                    let html = '';
                    hotSearches.forEach(item => {
                        html += `<button title="${item.term}" class="text-sm text-ios-blue bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition-colors hot-search-btn">${item.term}</button>`;
                    });
                    container.innerHTML = html;

                    // 为热搜按钮添加点击事件
                    container.querySelectorAll('.hot-search-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            searchInput.value = btn.textContent;
                            performSearch();
                        });
                    });
                } else {
                    container.innerHTML = '';
                }
            } catch (error) {
                console.error('Failed to fetch hot searches:', error);
            }
        }

        // 渲染分类tab内容
        function renderCategoryTabContent(category) {
            const container = document.getElementById('categoryContentContainer');
            // 定义每个分类的固定数据
            const categoryData = {
    '电影': ['阿凡达3', '超人传承', '雷神5', '蜘蛛侠4', '奇异博士3', '尚气2', '碟中谍8', '速度与激情11', '侏罗纪世界4', '猩球崛起', '疯狂的麦克斯', '疾速追杀5', '沙丘3', '美国队长4', '雷霆特攻队', '神奇四侠', '刀锋战士', '海洋奇缘2', '冰雪奇缘3', '疯狂动物城2', '功夫熊猫4', '封神第二部', '传说', '射雕英雄传侠之大者'],
    '电视剧': ['庆余年2', '赘婿2', '唐朝诡事录2', '大奉打更人', '藏海传', '凡人修仙传', '赴山海', '水龙吟', '英雄联盟剧集', '人生切割术2', '星期三2', '最后生还者2', '鱿鱼游戏3', '甜蜜家园3', '三体', '莲花楼', '繁花', '与凤行', '墨雨云间', '狐妖小红娘', '狂飙', '漫长的季节', '人生复本'],
    '小说': ['大奉打更人', '宿命之环', '赤心巡天', '灵境行者', '道诡异仙', '深海余烬', '择日飞升', '万道剑尊', '星门', '黜龙', '我本无意成仙', '光阴之外', '诡秘之主', '明克街13号', '玩家凶猛', '长夜余火', '从红月开始', '黎明之剑', '镇妖博物馆', '这个人仙太过正经', '全球高武', '万族之劫', '第一序列'],
    '综艺': ['歌手2025', '乘风2025', '披荆斩棘', '声生不息', '奔跑吧', '极限挑战', '王牌对王牌', '你好星期六', '密室大逃脱', '明星大侦探', '五十公里桃花坞', '向往的生活', '天赐的声音', '乐队的夏天', '奇葩说', '一年一度喜剧大赛', '这!就是街舞', '种地吧', '哈哈哈哈哈', '半熟恋人', '心动的信号', '我们的歌'],
    '游戏': ['黑神话悟空', 'GTA6', '怪物猎人荒野', '永劫无间', '三角洲行动', '红色沙漠', '死亡搁浅2', '寂静岭2', '最终幻想7', '王国之心4', '刺客信条影', '星刃', '对马岛之魂', '艾尔登法环', '赛博朋克2077', '战神诸神黄昏', '塞尔达传说王国之泪', '博德之门3', '原神', '崩坏星穹铁道', '王者荣耀', '和平精英', '英雄联盟', '无畏契约', '燕云十六声'],
    '动漫': ['鬼灭之刃', '咒术回战3', '我独自升级2', '怪兽8号', '链锯人', '龙珠DAIMA', '海贼王', '死神千年血战篇', '间谍过家家3', '进击的巨人', '航海王', '名侦探柯南', '一人之下', '镖人', '雾山五行', '凡人修仙传', '斗破苍穹', '斗罗大陆', '完美世界', '吞噬星空', '中国奇谭', '转生成为史莱姆这档事', '无职转生', '辉夜大小姐想让我告白']
};
            
            // 获取当前分类的数据
            const data = categoryData[category] || [];
            
            // 渲染数据，不添加前缀
            if (data.length > 0) {
                let html = '';
                data.forEach(item => {
                    html += `<button title="${item}" class="text-sm text-ios-blue bg-blue-50 px-3 py-1 rounded-full hover:bg-blue-100 transition-colors category-item-btn">${item}</button>`;
                });
                container.innerHTML = html;
                
                // 为分类项按钮添加点击事件
                container.querySelectorAll('.category-item-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        searchInput.value = btn.textContent;
                        performSearch();
                    });
                });
            } else {
                container.innerHTML = '';
            }
        }

        // Tab切换处理
        function handleTabSwitch() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有tab的active类
                    document.querySelectorAll('.category-tab').forEach(t => {
                        t.classList.remove('active');
                    });
                    
                    // 为当前tab添加active类
                    tab.classList.add('active');
                    
                    // 获取分类
                    const category = tab.getAttribute('data-category');
                    
                    // 根据分类渲染内容
                    if (category === 'hot') {
                        fetchAndRenderHotTabContent();
                    } else {
                        renderCategoryTabContent(category);
                    }
                });
            });
        }

        // 页面加载时初始化tab切换和获取热搜
        document.addEventListener('DOMContentLoaded', () => {
            handleTabSwitch();
            fetchAndRenderHotTabContent();
        });

        // --- 新版搜索模式切换逻辑 ---
        function setSearchMode(mode, isInitial = false) {
            if (!isInitial && currentSearchMode === mode) return;
            
            currentSearchMode = mode;
            
            if (mode === 'deep') {
                modeSlider.style.transform = 'translateX(100%)';
                modeDeepBtn.classList.add('active');
                modeFastBtn.classList.remove('active');
            } else {
                modeSlider.style.transform = 'translateX(0)';
                modeFastBtn.classList.add('active');
                modeDeepBtn.classList.remove('active');
            }
            
            if (!isInitial) {
                localStorage.setItem('searchMode', mode);
            }
        }

        modeFastBtn.addEventListener('click', () => setSearchMode('fast'));
        modeDeepBtn.addEventListener('click', () => setSearchMode('deep'));

        // 页面加载时初始化搜索模式
        document.addEventListener('DOMContentLoaded', () => {
            const savedMode = localStorage.getItem('searchMode') || 'deep'; // 默认深度
            setSearchMode(savedMode, true);
        });

        // 返回顶部按钮逻辑
        const backToTopBtn = document.getElementById('backToTopBtn');

        window.onscroll = function() {
            if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                backToTopBtn.style.display = "flex";
            } else {
                backToTopBtn.style.display = "none";
            }
        };

        backToTopBtn.addEventListener('click', () => {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });
        
        // 执行搜索
        async function performSearch() {
            const keyword = searchInput.value.trim();
            if (!keyword || isSearching) return;

            if (randomCollectionsEl) {
                randomCollectionsEl.style.display = 'none';
            }

            // 根据新的模式变量确定src参数
            const src = currentSearchMode === 'deep' ? 'all' : 'tg';

            isInitialLoad = false;
            isSearching = true;
            
            // 更新搜索按钮状态
            const originalText = searchButton.textContent;
            searchButton.disabled = true;
            searchButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>搜';
            searchButton.classList.add('opacity-75');
            
            // 隐藏重置按钮
            resetButton.classList.add('hidden');

            // 首先检查是否为违规词
            try {
                const checkResponse = await fetch('/api/check-term', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ term: keyword })
                });
                if (checkResponse.ok) {
                    const checkResult = await checkResponse.json();
                    if (checkResult.isForbidden) {
                        renderEmptyResults(); // 使用默认的"无结果"提示
                        return;
                    }
                }
            } catch (error) {
                console.error("Failed to check term:", error);
                // 如果检查失败，可以选择继续搜索或显示错误，这里我们选择继续
            }
            
            // 显示加载状态
            showLoading();
            
            fetch(`https://api.jkai.de/api/search?kw=${encodeURIComponent(keyword)}&src=${src}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(async data => {
                    // 首先，检查API请求是否成功，但没有返回任何数据
                    if (data.code === 0 && (!data.data || data.data.total === 0)) {
                        renderEmptyResults();
                        return;
                    }

                    // 其次，检查API是否返回了错误
                    if (data.code !== 0 || !data.data.merged_by_type) {
                        renderResults(data); // 直接渲染错误状态
                        return;
                    }

                    // --- 数据清洗和过滤 ---
                    const platformDomains = {
                        'aliyun': 'aliyundrive.com',
                        'quark': 'pan.quark.cn',
                        'baidu': 'pan.baidu.com',
                        '115': '115.com',
                        'xunlei': 'pan.xunlei.com',
                        'uc': 'drive.uc.cn',
                        'tianyi': 'cloud.189.cn',
                        '123': '123pan.com',
                        'mobile': 'caiyun.feixin.10086.cn'
                    };

                    let filteredMergedByType = {};
                    let filteredTotal = 0;

                    // 获取失效状态
                    const allResourceUrls = Object.values(data.data.merged_by_type).flat().map(r => r.url).filter(url => url);
                    let invalidStatus = {};
                    if (allResourceUrls.length > 0) {
                        const invalidStatusResponse = await fetch('/api/get-invalid-status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ urls: allResourceUrls })
                        });
                        if (invalidStatusResponse.ok) {
                            const result = await invalidStatusResponse.json();
                            if(result.success) {
                                invalidStatus = result.invalidStatus;
                            }
                        }
                    }

                    for (const platform in data.data.merged_by_type) {
                        const items = data.data.merged_by_type[platform];
                        const validItems = items.filter(item => {
                            if (invalidStatus[item.url]) return false; // 过滤失效资源
                            if (!item.url || item.url.trim() === '') return false;
                            const expectedDomain = platformDomains[platform];
                            if (expectedDomain && !item.url.includes(expectedDomain)) return false;
                            return true;
                        });

                        if (validItems.length > 0) {
                            filteredMergedByType[platform] = validItems;
                            filteredTotal += validItems.length;
                        }
                    }
                    // --- 过滤结束 ---

                    const filteredData = {
                        ...data,
                        data: {
                            ...data.data,
                            merged_by_type: filteredMergedByType,
                            total: filteredTotal
                        }
                    };
                    
                    currentData = filteredData; // 更新缓存为过滤后的数据

                    if (filteredTotal === 0) {
                        renderEmptyResults("未找到有效资源，已过滤无效或不匹配的链接。");
                    } else {
                        renderFilters(filteredData);
                        renderResults(filteredData);
                    }

                    if (filteredTotal > 0) {
                        renderFilters(filteredData);
                        renderResults(filteredData);
                        // 只有在有有效结果时才记录搜索词
                        recordSearchTerm(keyword);
                    } else {
                        renderEmptyResults("未找到有效资源，已过滤无效或不匹配的链接。");
                    }
                })
                .catch(error => {
                    console.error('Fetch Error:', error);
                    renderResults({
                        code: -1,
                        message: `请求失败: ${error.message}`
                    });
                })
                .finally(() => {
                    // 恢复搜索按钮状态
                    isSearching = false;
                    searchButton.disabled = false;
                    searchButton.textContent = originalText;
                    searchButton.classList.remove('opacity-75');
                    
                    // 如果搜索框中有内容，显示重置按钮
                    if (searchInput.value.trim() !== '') {
                        resetButton.classList.remove('hidden');
                    }
                });
        }
        
        // 记录搜索词
        function recordSearchTerm(term) {
            fetch('/api/hot-searches', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ term: term }),
            }).catch(error => console.error('Failed to record search term:', error));
        }

        // 显示加载状态
        function showLoading() {
            resultsHeader.classList.add('hidden');
            // 隐藏分类tab区域
            const categoryTabsContainer = document.getElementById('categoryTabsContainer');
            if (categoryTabsContainer) {
                categoryTabsContainer.classList.add('hidden');
            }
            resultsContainer.innerHTML = `
                <div class="ios-card p-8 text-center fade-in">
                    <div class="loading-dots mb-4">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <h3 class="text-xl font-medium mb-2">正在搜索资源</h3>
                    <p class="text-ios-gray">正在各大网盘搜索 "${searchInput.value}"</p>
                </div>
            `;
            filterContainer.classList.add('hidden');
        }

        function renderEmptyResults(message = "未找到相关资源") {
            resultsHeader.classList.remove('hidden');
            resultsCount.textContent = '共 0 条';
            
            // 提供搜索建议
            const suggestions = ['电影', '电视剧', '音乐', '软件', '游戏', '教程', '小说', '漫画'];
            const randomSuggestions = suggestions.sort(() => 0.5 - Math.random()).slice(0, 4);
            
            resultsContainer.innerHTML = `
                <div class="ios-card p-8 text-center fade-in">
                    <i class="fas fa-search text-4xl text-ios-gray mb-4"></i>
                    <h3 class="text-xl font-medium mb-2">${message}</h3>
                    <p class="text-ios-gray mb-6">请尝试更换关键词或检查输入是否正确</p>
                    <div class="mb-4">
                        <p class="text-sm text-ios-gray mb-3">试试这些热门搜索：</p>
                        <div class="flex flex-wrap justify-center gap-2">
                            ${randomSuggestions.map(suggestion =>
                                `<button class="suggestion-btn text-sm text-ios-blue bg-blue-50 px-3 py-2 rounded-full hover:bg-blue-100 transition-colors">${suggestion}</button>`
                            ).join('')}
                        </div>
                    </div>
                    <div class="mb-4">
                        <a href="/collections-static/collections.html" class="inline-block bg-gradient-to-r from-ios-blue to-blue-500 text-white px-6 py-3 rounded-xl font-medium hover:opacity-90 transition-opacity">
                            <i class="fas fa-folder-open mr-2"></i>去资源集合看看
                        </a>
                    </div>
                    <div class="text-xs text-ios-gray">
                        <p>💡 小贴士：使用 Ctrl+K (Mac: Cmd+K) 快速聚焦搜索框</p>
                    </div>
                </div>
            `;
            
            // 为建议按钮添加点击事件
            resultsContainer.querySelectorAll('.suggestion-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    searchInput.value = btn.textContent;
                    performSearch();
                });
            });
            
            filterContainer.classList.add('hidden');
            
            // 隐藏分类tab区域
            const categoryTabsContainer = document.getElementById('categoryTabsContainer');
            if (categoryTabsContainer) {
                categoryTabsContainer.classList.add('hidden');
            }
        }

        // 渲染筛选器
        function renderFilters(data) {
            if (data.code !== 0 || !data.data || !data.data.merged_by_type) {
                filterContainer.classList.add('hidden');
                return;
            }

            const mergedByType = data.data.merged_by_type;
            const platforms = Object.keys(mergedByType);

            if (platforms.length === 0) {
                filterContainer.classList.add('hidden');
                return;
            }

            let filterHTML = `<button class="filter-btn active" data-platform="all">全部</button>`;
            for (const platformType of platforms) {
                const platformInfo = platformMap[platformType] || { name: platformType };
                filterHTML += `<button class="filter-btn" data-platform="${platformType}">${platformInfo.name}</button>`;
            }

            filterContainer.querySelector('div').innerHTML = filterHTML;
            filterContainer.classList.remove('hidden');
        }
        
        // 渲染筛选后的空结果页面
        function renderFilteredEmptyResults(message = "在当前筛选条件下没有找到资源") {
            resultsContainer.innerHTML = `
                <div class="ios-card p-8 text-center fade-in">
                    <div class="text-5xl mb-4 text-ios-gray">
                        <i class="fas fa-filter"></i>
                    </div>
                    <h3 class="text-xl font-medium mb-2">筛选无结果</h3>
                    <p class="text-ios-gray mb-4">${message}</p>
                    <button class="clear-filter-btn text-ios-blue hover:underline" onclick="document.querySelector('.filter-btn[data-platform=all]').click()">
                        清除筛选条件
                    </button>
                </div>
            `;
            resultsCount.textContent = `共找到 0 个资源`;
            resultsHeader.classList.remove('hidden');
            
            // 隐藏分类tab区域
            const categoryTabsContainer = document.getElementById('categoryTabsContainer');
            if (categoryTabsContainer) {
                categoryTabsContainer.classList.add('hidden');
            }
        }

        // 渲染搜索结果
        function renderResults(data, filter = 'all') {
            currentFilter = filter; // 更新当前筛选条件
            if (data.code !== 0 || !data.data || !data.data.merged_by_type) {
                resultsContainer.innerHTML = `
                    <div class="ios-card p-8 text-center fade-in">
                        <div class="text-5xl mb-4 text-red-500">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <h3 class="text-xl font-medium mb-2">搜索遇到问题</h3>
                        <p class="text-ios-gray mb-4">${data.message || '网络连接异常，请稍后重试'}</p>
                        <div class="space-y-2">
                            <button class="retry-btn bg-ios-blue text-white px-4 py-2 rounded-lg hover:opacity-90 transition-opacity" onclick="performSearch()">
                                <i class="fas fa-redo mr-2"></i>重试
                            </button>
                            <p class="text-xs text-ios-gray">或检查网络连接后重新搜索</p>
                        </div>
                    </div>
                `;
                resultsHeader.classList.add('hidden');
                filterContainer.classList.add('hidden');
                
                // 隐藏分类tab区域
                const categoryTabsContainer = document.getElementById('categoryTabsContainer');
                if (categoryTabsContainer) {
                    categoryTabsContainer.classList.add('hidden');
                }
                
                return;
            }

            const mergedByType = data.data.merged_by_type;
            let totalResults = 0;
            
            // 构建HTML
            let resultsHTML = '';
            
            const platformsToRender = filter === 'all' 
                ? Object.entries(mergedByType)
                : Object.entries(mergedByType).filter(([platformType]) => platformType === filter);

            if (platformsToRender.length === 0) {
                renderFilteredEmptyResults();
                return;
            }

            // 按平台类型分组渲染
            for (const [platformType, resources] of platformsToRender) {
                const platformInfo = platformMap[platformType] || { 
                    name: platformType, 
                    icon: 'fa-cloud', 
                    color: 'bg-gray-500' 
                };
                
                // 应用排序
                const sortType = sortSelect.value;
                const sortedResources = sortResults(resources, sortType);
                
                totalResults += sortedResources.length;
                
                let platformHTML = `
                    <div class="ios-card overflow-hidden fade-in">
                        <div class="p-4 flex items-center border-b border-gray-100">
                            <div class="platform-icon ${platformInfo.color}">
                                <i class="fas ${platformInfo.icon}"></i>
                            </div>
                            <h3 class="font-semibold text-lg ml-3">${platformInfo.name}</h3>
                            <span class="ml-auto bg-gray-100 rounded-full px-3 py-1 text-sm mr-4">${sortedResources.length}个资源</span>
                            ${sortedResources.length > 3 ? `
                                <button class="text-ios-blue text-sm font-medium toggle-btn" data-platform="${platformType}" data-expanded="false">
                                    <span class="expand-text">展开</span>
                                    <span class="collapse-text hidden">收起</span>
                                    <i class="fas fa-chevron-down ml-1 text-xs transition-transform"></i>
                                </button>
                            ` : ''}
                        </div>
                        <div class="divide-y divide-gray-100">
                `;
                
                const initialVisibleCount = 3;
                sortedResources.forEach((resource, index) => {
                    // 格式化日期
                    let dateStr = '';
                    if (resource.datetime && resource.datetime !== '0001-01-01T00:00:00Z') {
                        const date = new Date(resource.datetime);
                        dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                    }
                    
                    const isHidden = index >= initialVisibleCount ? 'hidden' : '';

                    platformHTML += `
                        <a href="${resource.url}" target="_blank" rel="noreferrer" class="block result-item ${isHidden}" data-platform="${platformType}">
                            <div class="p-4">
                                <div class="flex justify-between">
                                    <div class="font-medium truncate pr-2">${resource.note}</div>
                                </div>
                                <div class="flex flex-col sm:flex-row sm:justify-between mt-2">
                                    <div class="text-sm text-ios-gray flex items-center mb-2 sm:mb-0">
                                        <i class="far fa-clock mr-1"></i>
                                        ${dateStr || '时间未知'}
                                    </div>
                                    <div class="flex items-center gap-3 flex-wrap justify-start">
                                        ${resource.password ? `<span class="password-tag">提取码: ${resource.password}</span>` : ''}
                                        <button class="copy-link-btn text-sm text-ios-gray hover:text-ios-blue transition-colors flex items-center" data-url="${resource.url}" title="复制链接">
                                            <i class="fas fa-copy mr-1 text-xs"></i>
                                            复制
                                        </button>
                                        <button class="mark-invalid-btn text-sm text-red-500 hover:text-red-700 transition-colors flex items-center" data-url="${resource.url}" title="标记为失效链接">
                                            <i class="fas fa-times-circle mr-1 text-xs"></i>
                                            标记失效
                                        </button>
                                        <div class="text-sm text-ios-blue flex items-center">
                                            立即查看 <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </a>
                    `;
                });
                
                platformHTML += `</div>`;

                if (sortedResources.length > initialVisibleCount) {
                    platformHTML += `
                        <div class="p-3 text-center border-t border-gray-100 show-more-container">
                            <button class="text-ios-blue text-sm font-medium show-more-btn" data-platform="${platformType}">
                                显示更多 (${sortedResources.length - initialVisibleCount}个) <i class="fas fa-chevron-down ml-1 text-xs transition-transform"></i>
                            </button>
                        </div>
                    `;
                }

                platformHTML += `</div>`;
                resultsHTML += platformHTML;
            }
            
            // 更新结果容器
            resultsContainer.innerHTML = resultsHTML;
            
            // 更新结果统计
            let finalTotal = 0;
            if (filter === 'all') {
                finalTotal = Object.values(data.data.merged_by_type).reduce((sum, res) => sum + res.length, 0);
            } else {
                finalTotal = data.data.merged_by_type[filter]?.length || 0;
            }
            resultsCount.textContent = `共找到 ${finalTotal} 个资源`;
            resultsHeader.classList.remove('hidden');
            
            // 隐藏分类tab区域
            const categoryTabsContainer = document.getElementById('categoryTabsContainer');
            if (categoryTabsContainer) {
                categoryTabsContainer.classList.add('hidden');
            }
        }
        
        // 事件委托处理筛选、显示更多、展开/收起
        filterContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                const platform = e.target.dataset.platform;
                
                // 更新按钮激活状态
                filterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');

                // 重新渲染结果
                renderResults(currentData, platform);
            }
        });

        resultsContainer.addEventListener('click', (e) => {
            const showMoreBtn = e.target.closest('.show-more-btn');
            const toggleBtn = e.target.closest('.toggle-btn');
            const copyBtn = e.target.closest('.copy-link-btn');
            const markInvalidBtn = e.target.closest('.mark-invalid-btn');

            if (copyBtn) {
                e.preventDefault();
                e.stopPropagation();
                copyToClipboard(copyBtn.dataset.url, copyBtn);
            } else if (markInvalidBtn) {
                e.preventDefault();
                e.stopPropagation();
                const resourceUrl = markInvalidBtn.dataset.url;
                markResourceAsInvalid(resourceUrl, markInvalidBtn);
            } else if (showMoreBtn) {
                handleToggle(showMoreBtn.dataset.platform, showMoreBtn);
                showMoreBtn.parentElement.classList.add('hidden'); // Hide "Show More" after click
            } else if (toggleBtn) {
                handleToggle(toggleBtn.dataset.platform, toggleBtn);
            }
        });

        function handleToggle(platform, button) {
            const isExpanded = button.dataset.expanded === 'true';
            const items = resultsContainer.querySelectorAll(`.result-item[data-platform="${platform}"]`);
            const initialVisibleCount = 3;

            items.forEach((item, index) => {
                if (index >= initialVisibleCount) {
                    item.classList.toggle('hidden', isExpanded);
                }
            });
            
            // Update all buttons for this platform
            const allToggleButtons = resultsContainer.querySelectorAll(`.toggle-btn[data-platform="${platform}"]`);
            allToggleButtons.forEach(btn => {
                btn.dataset.expanded = !isExpanded;
                btn.querySelector('.expand-text').classList.toggle('hidden', !isExpanded);
                btn.querySelector('.collapse-text').classList.toggle('hidden', isExpanded);
                btn.querySelector('i').classList.toggle('fa-chevron-down', isExpanded);
                btn.querySelector('i').classList.toggle('fa-chevron-up', !isExpanded);
            });

            // Hide the "show more" button container if it exists and we are expanding
            const showMoreContainer = resultsContainer.querySelector(`.show-more-btn[data-platform="${platform}"]`)?.parentElement;
            if (showMoreContainer && !isExpanded) {
                showMoreContainer.classList.add('hidden');
            }
        }
        
        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // 排序函数
        function sortResults(resources, sortType) {
            if (!resources || resources.length === 0) return resources;
            
            const sorted = [...resources];
            
            switch (sortType) {
                case 'date-desc':
                    return sorted.sort((a, b) => {
                        const dateA = new Date(a.datetime || '1970-01-01');
                        const dateB = new Date(b.datetime || '1970-01-01');
                        return dateB - dateA;
                    });
                case 'date-asc':
                    return sorted.sort((a, b) => {
                        const dateA = new Date(a.datetime || '1970-01-01');
                        const dateB = new Date(b.datetime || '1970-01-01');
                        return dateA - dateB;
                    });
                case 'name-asc':
                    return sorted.sort((a, b) => (a.note || '').localeCompare(b.note || '', 'zh-CN'));
                case 'name-desc':
                    return sorted.sort((a, b) => (b.note || '').localeCompare(a.note || '', 'zh-CN'));
                default:
                    return resources; // 保持原始顺序
            }
        }

        // 标记资源为失效
        async function markResourceAsInvalid(resourceUrl, button) {
            if (confirm('您确定要将此资源标记为失效吗？')) {
                try {
                    const response = await fetch('/api/mark-invalid', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ url: resourceUrl }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            // 视觉上禁用按钮，并提示用户
                            button.disabled = true;
                            button.innerHTML = '<i class="fas fa-check-circle mr-1 text-xs"></i> 已标记';
                            button.classList.remove('text-red-500', 'hover:text-red-700');
                            button.classList.add('text-gray-400', 'cursor-not-allowed');
                            
                            // 可以在这里添加一个更友好的提示，比如一个小的toast通知
                            console.log('资源已成功标记为失效');
                        } else {
                            throw new Error(result.message || '标记失败');
                        }
                    } else {
                        throw new Error('网络请求失败');
                    }
                } catch (error) {
                    console.error('标记失效时出错:', error);
                    // 可以在这里向用户显示一个错误提示
                    alert('标记失败，请稍后重试。');
                }
            }
        }

        // 复制到剪贴板功能
        async function copyToClipboard(url, button) {
            try {
                await navigator.clipboard.writeText(url);
                
                // 更新按钮状态显示成功
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1 text-xs"></i>已复制';
                button.classList.remove('text-ios-gray', 'hover:text-ios-blue');
                button.classList.add('text-green-500');
                
                // 2秒后恢复原状
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.classList.remove('text-green-500');
                    button.classList.add('text-ios-gray', 'hover:text-ios-blue');
                }, 2000);
                
            } catch (err) {
                // 如果现代API失败，尝试使用传统方法
                try {
                    const textArea = document.createElement('textarea');
                    textArea.value = url;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    // 更新按钮状态显示成功
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check mr-1 text-xs"></i>已复制';
                    button.classList.remove('text-ios-gray', 'hover:text-ios-blue');
                    button.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.classList.remove('text-green-500');
                        button.classList.add('text-ios-gray', 'hover:text-ios-blue');
                    }, 2000);
                    
                } catch (fallbackErr) {
                    // 如果都失败了，显示错误状态
                    const originalHTML = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-times mr-1 text-xs"></i>复制失败';
                    button.classList.remove('text-ios-gray', 'hover:text-ios-blue');
                    button.classList.add('text-red-500');
                    
                    setTimeout(() => {
                        button.innerHTML = originalHTML;
                        button.classList.remove('text-red-500');
                        button.classList.add('text-ios-gray', 'hover:text-ios-blue');
                    }, 2000);
                }
            }
        }

        // 添加键盘快捷键支持
        document.addEventListener('keydown', (e) => {
            // Ctrl+K 或 Cmd+K 聚焦搜索框
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
            
            // ESC 清空搜索框
            if (e.key === 'Escape' && document.activeElement === searchInput) {
                searchInput.value = '';
                searchInput.blur();
            }
        });

        // 页面加载时获取热搜
        document.addEventListener('DOMContentLoaded', fetchAndRenderHotSearches);
    </script>
    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }, err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    
        // QR Code Modal Logic
        const qrModal = document.getElementById('qrModal');
        const mobileAccessBtn = document.getElementById('mobileAccessBtn');
        const closeQrBtn = document.getElementById('closeQrModal');

        mobileAccessBtn.addEventListener('click', () => {
            qrModal.style.display = 'flex';
            setTimeout(() => qrModal.classList.add('visible'), 10);
        });
    
        const closeModal = () => {
            qrModal.classList.remove('visible');
            setTimeout(() => qrModal.style.display = 'none', 300);
        };
    
        closeQrBtn.addEventListener('click', closeModal);
        qrModal.addEventListener('click', (e) => {
            if (e.target === qrModal) {
                closeModal();
            }
        });
    
        // PWA Installation Prompt Logic
        let deferredPrompt;
        const installButton = document.getElementById('installPwaBtn');
    
        window.addEventListener('beforeinstallprompt', (e) => {
            const isMobile = window.matchMedia("only screen and (max-width: 768px)").matches;
            if (isMobile) {
                e.preventDefault();
                deferredPrompt = e;
                if (installButton) {
                    installButton.style.display = 'flex';
                }
            }
        });
    
        if (installButton) {
            installButton.addEventListener('click', (e) => {
                if (deferredPrompt) {
                    installButton.style.display = 'none';
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the A2HS prompt');
                        } else {
                            console.log('User dismissed the A2HS prompt');
                        }
                        deferredPrompt = null;
                    });
                }
            });
        }
        
        window.addEventListener('appinstalled', (evt) => {
          console.log('PWA was installed.');
          if (installButton) {
            installButton.style.display = 'none';
          }
        });
    
        // Show mobile access button only on desktop
        document.addEventListener('DOMContentLoaded', () => {
            const isMobile = window.matchMedia("only screen and (max-width: 768px)").matches;
            if (!isMobile) {
                mobileAccessBtn.style.display = 'flex';
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (!randomCollectionsEl) return;

            fetch('/collections-static/collections.json')
                .then(response => response.json())
                .then(data => {
                    const collections = data.collections;
                    if (collections && collections.length > 0) {
                        const randomThree = collections.sort(() => 0.5 - Math.random()).slice(0, 3);
                        
                        let html = '<h2 class="text-2xl font-bold text-center mb-6">猜你喜欢</h2>';
                        html += '<div class="scroll-container pb-4">';

                        randomThree.forEach(collection => {
                            const isExternalUrl = collection.cover && (collection.cover.startsWith('http://') || collection.cover.startsWith('https://'));
                            const coverImage = collection.cover ?
                                (isExternalUrl ? collection.cover : `/collections-static/images/${collection.cover.split('/').pop()}`) :
                                '';

                            html += `
                                <a href="/collections-static/${collection.id}.html" class="ios-card p-4 block hover:shadow-ios-card transition-shadow scroll-item">
                                    <div class="h-40 bg-gray-200 rounded-lg mb-4 overflow-hidden">
                                        ${coverImage ? `<img src="${coverImage}" alt="${collection.title}" class="w-full h-full object-cover">` : ''}
                                    </div>
                                    <h3 class="font-semibold text-lg mb-1 truncate">${collection.title}</h3>
                                    <p class="text-ios-gray text-sm truncate">${collection.description}</p>
                                </a>
                            `;
                        });

                        html += '</div>';
                        randomCollectionsEl.innerHTML = html;
                    }
                })
                .catch(error => console.error('Error fetching random collections:', error));
        });
    </script>
    </body>
</html>
